# phpvm Requirements and Implemented Features

This document describes what phpvm implements today, how to use it, and important behaviors and guarantees. phpvm is an NVM-style version manager for PHP, implemented as a single Rust CLI binary that works across macOS, Linux, and Windows.

## Platforms
- macOS (x86_64, Apple Silicon via Rosetta or native when built)
- Linux (glibc or musl; build from source supported)
- Windows (PowerShell; prebuilt zip installs supported, `nts`/`ts` flavors)

## Installation layout
- Root directory: `~/.phpvm/`
  - `versions/<version>/` — Installed PHP trees (Unix: typical `bin`, Windows: extracted zip layout)
  - `shims/` — Shims for `php`, `pecl`, `pear`, `composer`
  - `cache/` — Downloaded archives and temporary extraction/build folders
  - `manifests/` — Future: cached remote metadata
  - `config.toml` — User configuration (parallel jobs, default flags)
  - `global` — Default PHP version for new shells
  - `aliases.toml` — Aliases mapping names to versions (e.g., `stable` -> `8.3.11`)
  - `phpvm.psm1` — PowerShell module (generated by `phpvm init powershell`)

## Version selection precedence
- `PHPVM_VERSION` environment variable (highest)
- `.php-version` in current working directory or its ancestors
- `~/.phpvm/global` (fallback)

## CLI commands implemented
- `phpvm list-remote [--major <x.y>]`
  - Lists known versions from a remote manifest (currently stubbed list; easy to swap in real source).
- `phpvm list`
  - Lists installed versions and shows any configured aliases.
- `phpvm install <version> [--from source] [--ts]`
  - Downloads the PHP archive to cache, verifies and extracts it.
  - Unix: if `--from source`, extract official tarball and run `./configure && make -j && make install` into `~/.phpvm/versions/<version>`.
  - Windows: downloads official zip and extracts under `versions/<version>`. `--ts` selects the thread-safe flavor (placeholder URL pattern; adjust when wiring real release naming per version).
- `phpvm uninstall <version>`
  - Removes an installed version directory.
- `phpvm use <version>`
  - Prints shell-evaluable snippet to set `PHPVM_VERSION` for the current shell.
- `phpvm global <version|alias>`
  - Writes the global default version into `~/.phpvm/global`.
- `phpvm local <version>`
  - Writes `.php-version` in the current directory.
- `phpvm which [program]`
  - Resolves the path to `program` for the currently selected version (`php` by default).
- `phpvm exec <version> -- <cmd ...>`
  - Runs a command with the specified version placed first on PATH.
- `phpvm alias [<name> <version>] [--delete <name>]`
  - Creates/deletes/list aliases stored in `aliases.toml`.
- `phpvm cache prune`
  - Clears the cache folder.
- `phpvm doctor`
  - Prints key directories and a basic PATH diagnostic.
- `phpvm init [--shell bash|zsh|fish|powershell|-]`
  - Emits a snippet to prepend the shims directory to PATH.
  - On PowerShell, also writes `~/.phpvm/phpvm.psm1` and prints profile import instructions.
- `phpvm self-update`
  - Uses GitHub Releases (self_update crate) to update in-place when releases are configured.

## Shims
- Created under `~/.phpvm/shims` for `php`, `pecl`, `pear`, and `composer`.
- Unix: small `sh` launchers that resolve the current version and `exec` the real binary.
- Windows: `.cmd` shims that resolve the target executable and forward arguments.

## Downloader and integrity
- Streaming HTTP downloads with resume support (Range requests) to `*.part` files.
- Optional SHA256 verification (hook is in place; pass expected hash to enforce).

## Archive formats
- tar.xz (official PHP source)
- tar.gz (supported)
- zip (Windows builds)

## Unix source builds
- Extracts source tarball and runs standard `./configure`, `make -j<N>`, `make install`.
- Install prefix is the target version directory.
- Parallel jobs default to CPU count; configurable in `config.toml`.

## Windows specifics
- `--ts` flag selects thread-safe (`ts`) build; `nts` otherwise.
- Extracts zip into `versions/<version>`; `which`/`exec` search both `<version>/bin` and `<version>`.

## Shell integration
- POSIX shells: `eval "$(phpvm init)"` or add to rc files.
- Fish: `phpvm init --shell fish` prints `set -gx PATH ~/.phpvm/shims $PATH`.
- PowerShell: `phpvm init powershell` writes a module and prints import instructions.

## Configuration (`config.toml`)
- `jobs` (usize): parallelism for builds (Unix)
- `configure_flags` (list): extra flags to pass to `./configure` (Unix)
- `default_extensions` (list): reserved for future post-install actions (PECL)

## Security considerations
- All downloads use HTTPS; resumable.
- SHA256 verification support (provide hashes in manifest or user flags).
- Future: GPG signature verification of official PHP sources.

## Limitations and future work
- Remote manifest is stubbed; wire to official PHP APIs or curated manifests.
- PECL extension workflows and ini management are not yet implemented.
- Windows zip URL patterns may vary by release; normalize per-version metadata.
- Additional shims and richer `doctor` checks can be added.

## Examples
```bash
# POSIX init
export PATH="$(phpvm init -)"

# Install and set global
phpvm install 8.3.11
phpvm global 8.3.11

# Per-project version
phpvm local 8.2.23

# Use for current shell
eval "$(phpvm use 8.2.23)"

# Run a command with a specific version
phpvm exec 8.3.11 -- php -v
```
